{% extends 'admin_dashboard/base.html' %}

{% block page_title %}Calendar View{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReservationModal">
    <i class="fas fa-plus me-1"></i>
    New Reservation
</button>
{% endblock %}

{% block extra_css %}
<style>
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #dee2e6;
        border: 1px solid #dee2e6;
    }

    .calendar-cell {
        background-color: white;
        min-height: 120px;
        padding: 8px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s;
    }

        .calendar-cell:hover {
            background-color: #f8f9fa;
        }

        .calendar-cell.other-month {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .calendar-cell.today {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }

    .calendar-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
    }

    .reservation-item {
        font-size: 10px;
        padding: 2px 4px;
        margin: 1px 0;
        border-radius: 3px;
        cursor: pointer;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    .reservation-confirmed {
        background-color: #d4edda;
        color: #155724;
        border-left: 3px solid #28a745;
    }

    .reservation-pending {
        background-color: #fff3cd;
        color: #856404;
        border-left: 3px solid #ffc107;
    }

    .day-number {
        font-weight: bold;
        margin-bottom: 4px;
    }

    .month-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-right: 20px;
    }

    .legend-color {
        width: 16px;
        height: 16px;
        margin-right: 8px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="month-nav">
                    <div>
                        <a href="?year={{ year }}&month={{ prev_month.month }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        <span class="mx-3 h5 mb-0">{{ month_name }} {{ year }}</span>
                        <a href="?year={{ year }}&month={{ next_month.month }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                    <div class="d-flex">
                        <div class="legend-item">
                            <div class="legend-color bg-success"></div>
                            <small>Confirmed</small>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color bg-warning"></div>
                            <small>Pending</small>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #e3f2fd; border: 1px solid #2196f3;"></div>
                            <small>Today</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="calendar-grid">
                    <!-- Day headers -->
                    <div class="calendar-header">Sun</div>
                    <div class="calendar-header">Mon</div>
                    <div class="calendar-header">Tue</div>
                    <div class="calendar-header">Wed</div>
                    <div class="calendar-header">Thu</div>
                    <div class="calendar-header">Fri</div>
                    <div class="calendar-header">Sat</div>

                    <!-- Calendar days -->
                    {% for week in calendar_data %}
                    {% for day in week %}
                    <div class="calendar-cell {% if not day.in_current_month %}other-month{% endif %} {% if day.is_today %}today{% endif %}"
                         data-date="{{ day.date|date:'Y-m-d' }}"
                         onclick="showDayDetails('{{ day.date|date:'Y-m-d' }}')">
                        <div class="day-number">{{ day.date.day }}</div>
                        {% for reservation in day.reservations %}
                        <div class="reservation-item {% if reservation.confirmed %}reservation-confirmed{% else %}reservation-pending{% endif %}"
                             title="{{ reservation.user.username }} - {{ reservation.place.name }} ({{ reservation.start_time }}-{{ reservation.end_time }})"
                             onclick="event.stopPropagation(); showReservationDetails({{ reservation.id }})">
                            {{ reservation.start_time|time:'H:i' }} {{ reservation.place.name|truncatechars:10 }}
                        </div>
                        {% endfor %}
                        {% if day.reservations|length > 3 %}
                        <div class="text-muted small">+{{ day.reservations|length|add:'-3' }} more</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-calendar-check fa-2x mb-2"></i>
                <h4>{{ month_stats.total_reservations }}</h4>
                <small>Total Reservations</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stat-card-success">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h4>{{ month_stats.confirmed_reservations }}</h4>
                <small>Confirmed</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stat-card-warning">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h4>{{ month_stats.pending_reservations }}</h4>
                <small>Pending</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stat-card-info">
            <div class="card-body text-center">
                <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                <h4>{{ month_stats.active_places }}</h4>
                <small>Active Fields</small>
            </div>
        </div>
    </div>
</div>

<!-- Day Details Modal -->
<div class="modal fade" id="dayDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reservations for <span id="selectedDate"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="dayDetailsContent">
                <!-- Content loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Add Reservation Modal -->
<div class="modal fade" id="addReservationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Reservation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'admin_dashboard:admin_export_reservations' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">User</label>
                        <select name="user" class="form-select" required>
                            <option value="">Select User</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }} ({{ user.email }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Field</label>
                        <select name="place" class="form-select" required>
                            <option value="">Select Field</option>
                            {% for place in places %}
                            <option value="{{ place.id }}">{{ place.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" name="date" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Start Time</label>
                            <input type="time" name="start_time" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">End Time</label>
                            <input type="time" name="end_time" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" name="confirmed" class="form-check-input" id="confirmed">
                            <label class="form-check-label" for="confirmed">Confirmed</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Reservation</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showDayDetails(date) {
        document.getElementById('selectedDate').textContent = new Date(date).toLocaleDateString();

        fetch(`/admin/calendar/day-details/?date=${date}`)
            .then(response => response.json())
            .then(data => {
                let content = '';
                if (data.reservations.length === 0) {
                    content = '<p class="text-muted">No reservations for this day.</p>';
                } else {
                    content = '<div class="list-group">';
                    data.reservations.forEach(reservation => {
                        const statusClass = reservation.confirmed ? 'success' : 'warning';
                        const statusText = reservation.confirmed ? 'Confirmed' : 'Pending';

                        content += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${reservation.user__username}</h6>
                                    <p class="mb-1">${reservation.place__name}</p>
                                    <small>${reservation.start_time} - ${reservation.end_time}</small>
                                </div>
                                <div>
                                    <span class="badge bg-${statusClass}">${statusText}</span>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/admin/reservations/${reservation.id}/" class="btn btn-outline-primary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    });
                    content += '</div>';
                }

                document.getElementById('dayDetailsContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('dayDetailsModal')).show();
            });
    }

    function showReservationDetails(reservationId) {
        window.location.href = `/admin/reservations/${reservationId}/`;
    }

    // Set today's date as default in the add reservation modal
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.querySelector('#addReservationModal input[name="date"]');
        if (dateInput) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    });
</script>
{% endblock %}